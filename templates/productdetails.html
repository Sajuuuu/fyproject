{% extends 'base.html' %}
{% block title %}Shop - Pethood{% endblock %}
{% load static %}
{% block content %}

<div class="product-detail">
  <div class="image-section">
    <img src="{{ product.image.url }}" alt="{{ product.name }}">
  </div>

  <div class="info-section">
    <h2>{{ product.name }}</h2>
    <p class="price">रु{{ product.price }}</p>
    <p class="description">{{ product.description }}</p>

    {% if product.category == "clothes" or product.category == "accessories" %}
       <label for="size-select-{{ product.id }}">Select Size:</label>
       <select id="size-select-{{ product.id }}">
        
        <option value="S">Small</option>
        <option value="M" {% if product.size == "M" %}selected{% endif %}>Medium</option>
        <option value="L">Large</option>
      </select>
    {% endif %}

    <div class="action-buttons">
      <button class="add-cart" data-product-id="{{ product.id }}">Add to Cart</button>
      <button class="buy-now" data-product-id="{{ product.id }}">Buy Now</button>
    </div>
  </div>
</div>

<!-- ORIGINAL CSS from yesterday -->
<style>
  body {
    background-color: #fff9f0;
    font-family: 'Arial', sans-serif;
    color: #333;
}
.product-detail {
  display: flex;
  flex-wrap: wrap;
  max-width: 1000px;
  margin: 40px auto;
  background: #fff;
  border-radius: 15px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  overflow: hidden;
  transition: transform 0.3s ease;
}
.product-detail:hover { transform: translateY(-5px); }

.image-section {
  flex: 1 1 400px;
  background: #f9f9f9;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.image-section img {
  max-width: 100%;
  max-height: 450px;
  object-fit: contain;
  border-radius: 12px;
}

.info-section {
  flex: 1 1 400px;
  padding: 30px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.info-section h2 { font-size: 28px; font-weight: 700; margin-bottom: 15px; }
.info-section .price { font-size: 22px; color: #bd6c49; font-weight: bold; margin-bottom: 20px; }
.info-section .description { font-size: 16px; color: #555; margin-bottom: 25px; line-height: 1.6; }
.info-section label { font-weight: 600; margin-bottom: 8px; display: block; }
.info-section select {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
  margin-bottom: 25px;
  cursor: pointer;
  transition: border 0.2s, box-shadow 0.2s;
}
.info-section select:hover, .info-section select:focus {
  border-color: #283f57;
  box-shadow: 0 0 6px rgba(224,123,82,0.3);
}

.action-buttons {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}

.add-cart, .buy-now {
  flex: 1;
  min-width: 150px;
  padding: 14px 25px;
  font-size: 16px;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.3s, transform 0.2s;
}

.add-cart {
  background: #0f1010;
  color: #fff;
}
.add-cart:hover {
  background: #293b48;
  transform: translateY(-2px);
}

.buy-now {
  background: #b30047;
  color: #fff;
}
.buy-now:hover {
  background: #8f0038;
  transform: translateY(-2px);
}

@media (max-width: 900px) {
  .product-detail { flex-direction: column; }
  .image-section, .info-section { flex: 1 1 100%; }
  .info-section { padding: 20px; }
}
</style>

<!-- AJAX Add to Cart & Buy Now JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Cart items already in cart (from server)
    const cartItemsInCart = {{ cart_items_in_cart|safe }};
    
    // Function to check and update button state
    function updateAddToCartButton() {
        const addCartBtn = document.querySelector('.add-cart');
        const productId = addCartBtn.dataset.productId;
        const sizeSelector = document.querySelector(`#size-select-${productId}`);
        const size = sizeSelector ? sizeSelector.value : null;
        
        // Check if this product+size combo is already in cart
        const isInCart = cartItemsInCart.includes(size);
        
        if (isInCart) {
            addCartBtn.disabled = true;
            addCartBtn.innerText = "Already in Cart";
            addCartBtn.style.backgroundColor = "#777";
            addCartBtn.style.cursor = "not-allowed";
        } else {
            addCartBtn.disabled = false;
            addCartBtn.innerText = "Add to Cart";
            addCartBtn.style.backgroundColor = "#0f1010";
            addCartBtn.style.cursor = "pointer";
        }
    }
    
    // Update button state on size change
    const sizeSelectors = document.querySelectorAll('[id^="size-select-"]');
    sizeSelectors.forEach(selector => {
        selector.addEventListener('change', updateAddToCartButton);
    });
    
    // Initial check
    updateAddToCartButton();
    
    // Select all Add to Cart buttons
    const buttons = document.querySelectorAll('.add-cart');

    buttons.forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;

            // Get the size if the selector exists
            const sizeSelector = document.querySelector(`#size-select-${productId}`);
            const size = sizeSelector ? sizeSelector.value : null;

            fetch(`/add-to-cart-ajax/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ size: size })
            })
            .then(res => res.json())
            .then(data => {
                if(data.redirect){
                    // User not logged in, redirect to login
                    window.location.href = data.redirect;
                    return;
                }
                
                if(data.already_in_cart){
                    // Item already in cart
                    alert(data.message || 'This item is already in your cart');
                    this.disabled = true;
                    this.innerText = "Already in Cart";
                    this.style.backgroundColor = "#777";
                    return;
                }
                
                if(data.success){
                    // Update cart count in navbar badge
                    const cartBadge = document.getElementById('cart-badge');
                    if(cartBadge) cartBadge.innerText = data.cart_count;

                    // Add size to cart items list
                    cartItemsInCart.push(size);

                    // Show temporary success message on button
                    const originalText = this.innerText;
                    this.innerText = "Added Successfully";
                    this.disabled = true;

                    setTimeout(() => {
                        updateAddToCartButton();
                    }, 1000);
                }
            })
            .catch(err => console.error('Error adding to cart:', err));
        });
    });

    // Buy Now functionality
    const buyNowButtons = document.querySelectorAll('.buy-now');
    buyNowButtons.forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;

            // Get the size if the selector exists
            const sizeSelector = document.querySelector(`#size-select-${productId}`);
            const size = sizeSelector ? sizeSelector.value : null;

            fetch(`/buy-now-ajax/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ size: size })
            })
            .then(res => res.json())
            .then(data => {
                if(data.redirect){
                    // Redirect to login or checkout
                    window.location.href = data.redirect;
                }
            })
            .catch(err => console.error('Error with buy now:', err));
        });
    });
});
</script>

<!-- Recommendations Section -->
{% if frequently_bought or similar_products %}
<style>
.recommendations-section {
  max-width: 1200px;
  margin: 60px auto;
  padding: 0 20px;
}

.recommendations-section h3 {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 25px;
  color: #333;
  text-align: center;
}

.recommendations-section h3 span {
  color: #b30047;
}

.recommendations-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 25px;
  margin-top: 20px;
}

.recommendation-card {
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: transform 0.3s, box-shadow 0.3s;
  text-decoration: none;
  color: inherit;
  display: flex;
  flex-direction: column;
}

.recommendation-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}

.recommendation-card img {
  width: 100%;
  height: 220px;
  object-fit: contain;
  background: #f9f9f9;
  padding: 15px;
}

.recommendation-card-info {
  padding: 15px;
  flex: 1;
  display: flex;
  flex-direction: column;
}

.recommendation-card h4 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
  color: #333;
  line-height: 1.4;
}

.recommendation-card .price {
  font-size: 18px;
  font-weight: bold;
  color: #b30047;
  margin-top: auto;
}

@media (max-width: 768px) {
  .recommendations-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
  }
  
  .recommendation-card img {
    height: 160px;
  }
}
</style>

{% if frequently_bought %}
<div class="recommendations-section">
  <h3>Frequently <span>Bought Together</span></h3>
  <div class="recommendations-grid">
    {% for product in frequently_bought %}
    <a href="{% url 'productdetails' product.slug %}" class="recommendation-card">
      <img src="{{ product.image.url }}" alt="{{ product.name }}">
      <div class="recommendation-card-info">
        <h4>{{ product.name }}</h4>
        <p class="price">रु{{ product.price }}</p>
      </div>
    </a>
    {% endfor %}
  </div>
</div>
{% endif %}

{% if similar_products %}
<div class="recommendations-section">
  <h3>Similar <span>Products</span></h3>
  <div class="recommendations-grid">
    {% for product in similar_products %}
    <a href="{% url 'productdetails' product.slug %}" class="recommendation-card">
      <img src="{{ product.image.url }}" alt="{{ product.name }}">
      <div class="recommendation-card-info">
        <h4>{{ product.name }}</h4>
        <p class="price">रु{{ product.price }}</p>
      </div>
    </a>
    {% endfor %}
  </div>
</div>
{% endif %}
{% endif %}

{% endblock %}




